<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book a Meeting | CalKiller</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto py-12 px-4">
    <div class="text-center mb-12">
      <div class="w-16 h-16 bg-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center">
        <span class="text-white text-2xl">üìÖ</span>
      </div>
      <h1 id="owner-name" class="text-3xl font-bold text-gray-900">Loading...</h1>
      <p class="text-gray-600 mt-2">Select a time that works for you</p>
    </div>

    <div id="meeting-types" class="grid md:grid-cols-2 gap-4 mb-8"></div>

    <div class="grid md:grid-cols-2 gap-8">
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
          <button id="prev-week" class="p-2 hover:bg-gray-100 rounded-lg">‚Üê</button>
          <h2 id="week-label" class="text-lg font-semibold"></h2>
          <button id="next-week" class="p-2 hover:bg-gray-100 rounded-lg">‚Üí</button>
        </div>
        <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center"></div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 id="selected-date" class="text-lg font-semibold mb-4">Select a date</h2>
        <div id="time-slots" class="space-y-2 max-h-96 overflow-y-auto">
          <p class="text-gray-500 text-center py-8">Select a date to see available times</p>
        </div>
      </div>
    </div>

    <div id="booking-form" class="hidden mt-8 bg-white rounded-2xl shadow-lg p-8">
      <h2 class="text-xl font-semibold mb-6">Complete your booking</h2>
      <form id="form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Your Name *</label>
          <input type="text" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
          <input type="email" id="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
          <textarea id="notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
        <div id="booking-summary" class="bg-gray-50 p-4 rounded-lg"></div>
        <button type="submit" id="submit-btn" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700">Confirm Booking</button>
      </form>
    </div>

    <div id="success-message" class="hidden mt-8 bg-green-50 rounded-2xl shadow-lg p-8 text-center">
      <div class="text-6xl mb-4">‚úÖ</div>
      <h2 class="text-2xl font-bold text-green-800 mb-2">Booking Confirmed!</h2>
      <p class="text-green-700">Check your email for confirmation details.</p>
      <button onclick="location.reload()" class="mt-6 bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700">Book Another</button>
    </div>

    <div class="text-center mt-12 text-gray-500 text-sm">Powered by CalKiller üî™</div>
  </div>

  <script>
    let config = {}, selectedDate = null, selectedSlot = null, selectedMeetingType = null;
    let currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1);

    async function init() {
      const res = await fetch('/api/config');
      config = await res.json();
      document.getElementById('owner-name').textContent = config.ownerName;
      renderMeetingTypes();
      renderCalendar();
    }

    function renderMeetingTypes() {
      const container = document.getElementById('meeting-types');
      container.innerHTML = config.meetingTypes.map((type, i) => `
        <button onclick="selectMeetingType('${type.id}')" id="meeting-${type.id}"
          class="meeting-type-btn p-4 bg-white rounded-xl shadow border-2 ${i === 0 ? 'border-indigo-500' : 'border-transparent'} hover:border-indigo-500 text-left">
          <div class="font-semibold">${type.name}</div>
          <div class="text-sm text-gray-500">${type.duration} minutes</div>
          <div class="text-sm text-gray-600 mt-1">${type.description}</div>
        </button>
      `).join('');
      if (config.meetingTypes.length > 0) selectedMeetingType = config.meetingTypes[0];
    }

    function selectMeetingType(id) {
      selectedMeetingType = config.meetingTypes.find(t => t.id === id);
      document.querySelectorAll('.meeting-type-btn').forEach(btn => btn.classList.replace('border-indigo-500', 'border-transparent'));
      document.getElementById(`meeting-${id}`).classList.replace('border-transparent', 'border-indigo-500');
      if (selectedDate) loadSlots(selectedDate);
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const weekLabel = document.getElementById('week-label');
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      weekLabel.textContent = `${months[currentWeekStart.getMonth()]} ${currentWeekStart.getFullYear()}`;
      let html = days.map(d => `<div class="text-xs font-medium text-gray-500 py-2">${d}</div>`).join('');
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + i);
        const isToday = date.toDateString() === new Date().toDateString();
        const isPast = date < new Date(new Date().setHours(0, 0, 0, 0));
        const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
        html += `<button onclick="selectDate('${date.toISOString()}')" ${isPast ? 'disabled' : ''}
          class="py-3 rounded-lg text-sm font-medium ${isPast ? 'text-gray-300' : 'hover:bg-indigo-50'}
          ${isToday ? 'bg-indigo-100 text-indigo-700' : ''} ${isSelected ? 'bg-indigo-600 text-white' : ''}">${date.getDate()}</button>`;
      }
      grid.innerHTML = html;
    }

    async function selectDate(dateStr) {
      selectedDate = new Date(dateStr);
      renderCalendar();
      loadSlots(selectedDate);
    }

    async function loadSlots(date) {
      const container = document.getElementById('time-slots');
      document.getElementById('selected-date').textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
      container.innerHTML = '<p class="text-center py-8 text-gray-500">Loading...</p>';
      const start = new Date(date); start.setHours(0, 0, 0, 0);
      const end = new Date(date); end.setHours(23, 59, 59, 999);
      const res = await fetch(`/api/slots?start=${start.toISOString()}&end=${end.toISOString()}&duration=${selectedMeetingType?.duration || 30}`);
      const data = await res.json();
      if (data.slots.length === 0) { container.innerHTML = '<p class="text-center py-8 text-gray-500">No available times</p>'; return; }
      container.innerHTML = data.slots.map(slot => {
        const time = new Date(slot.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        return `<button onclick="selectSlot('${slot.start}', '${slot.end}')" class="w-full py-3 px-4 border border-gray-200 rounded-lg text-left hover:border-indigo-500 hover:bg-indigo-50"><span class="font-medium">${time}</span></button>`;
      }).join('');
    }

    function selectSlot(start, end) {
      selectedSlot = { start, end };
      document.getElementById('booking-form').classList.remove('hidden');
      const startDate = new Date(start);
      document.getElementById('booking-summary').innerHTML = `
        <div class="text-sm"><div class="font-medium">${selectedMeetingType?.name || 'Meeting'}</div>
        <div class="text-gray-600">${startDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} at ${startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</div>
        <div class="text-gray-500">${selectedMeetingType?.duration || 30} minutes</div></div>`;
      document.getElementById('booking-form').scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submit-btn');
      btn.disabled = true; btn.textContent = 'Booking...';
      const res = await fetch('/api/book', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: document.getElementById('name').value, email: document.getElementById('email').value, notes: document.getElementById('notes').value, startTime: selectedSlot.start, endTime: selectedSlot.end, meetingType: selectedMeetingType?.id })
      });
      const data = await res.json();
      if (data.success) { document.getElementById('booking-form').classList.add('hidden'); document.getElementById('success-message').classList.remove('hidden'); }
      else { alert(data.error || 'Booking failed'); btn.disabled = false; btn.textContent = 'Confirm Booking'; }
    });

    document.getElementById('prev-week').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); renderCalendar(); });
    document.getElementById('next-week').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); renderCalendar(); });
    init();
  </script>
</body>
</html>
